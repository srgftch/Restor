<!DOCTYPE html>
<html>
<head>
    <title>Restaurant Payment Test</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 20px auto; padding: 20px; }
        .step { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 12px 20px; margin: 10px 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #6c757d; }
        .hidden { display: none; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .sms-code { font-size: 24px; font-weight: bold; color: #007bff; text-align: center; margin: 10px 0; }
        .card-input { width: 250px; }
        .small-input { width: 80px; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
    </style>
</head>
<body>
<h1>üçΩÔ∏è Restaurant Booking Payment Test</h1>

<!-- –®–∞–≥ 0: –ü—Ä–æ–≤–µ—Ä–∫–∞ API -->
<div class="step">
    <h3>0. –ü—Ä–æ–≤–µ—Ä–∫–∞ API</h3>
    <button onclick="checkApiStatus()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å API</button>
    <div id="status-result"></div>
</div>

<!-- –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö -->
<div class="step" id="step1">
    <h3>1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h3>
    <button onclick="createTestData()">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
    <div id="step1-result"></div>
</div>

<!-- –®–∞–≥ 2: –û–ø–ª–∞—Ç–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="step hidden" id="step2">
    <h3>2. –û–ø–ª–∞—Ç–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
    <div class="info" id="booking-info"></div>

    <div class="form-group">
        <label><strong>–î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã:</strong></label>

        <div style="margin: 10px 0;">
            <label>–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç—ã:</label>
            <select id="cardSelect" onchange="fillCardFromSelect()" style="width: 300px;">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É --</option>
                <option value="4111111111111111">Visa 4111 1111 1111 1111 (—É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞)</option>
                <option value="2200387142388060">–ú–ò–† 2200 3871 4238 8060 (—É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞)</option>
                <option value="4111111111111110">Visa 4111 1111 1111 1110 (–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞)</option>
            </select>
        </div>

        <div style="margin: 15px 0;">
            <label>–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –≤—Ä—É—á–Ω—É—é:</label>
            <input type="text" id="cardNumber" placeholder="0000 0000 0000 0000" maxlength="19" class="card-input" oninput="formatCardNumber(this)">
        </div>

        <div style="display: flex; gap: 15px; margin: 10px 0;">
            <div>
                <label>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–º–µ—Å—è—Ü):</label>
                <input type="number" id="cardExpMonth" placeholder="MM" min="1" max="12" value="12" class="small-input">
            </div>
            <div>
                <label>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–≥–æ–¥):</label>
                <input type="number" id="cardExpYear" placeholder="YYYY" min="2024" max="2030" value="2025" class="small-input">
            </div>
            <div>
                <label>CVC:</label>
                <input type="text" id="cardCvc" placeholder="123" maxlength="3" value="123" class="small-input">
            </div>
        </div>
    </div>

    <button onclick="startPayment()">üí≥ –ù–∞—á–∞—Ç—å –æ–ø–ª–∞—Ç—É</button>
    <div id="step2-result"></div>
</div>

<!-- –®–∞–≥ 3: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ SMS -->
<div class="step hidden" id="step3">
    <h3>3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ SMS</h3>

    <!-- –ë–ª–æ–∫ —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º SMS –∫–æ–¥–æ–º -->
    <div id="sms-code-display" class="hidden">
        <p class="info">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SMS –∫–æ–¥:</p>
        <div class="sms-code" id="generated-sms-code"></div>
        <p class="info">–í–≤–µ–¥–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –Ω–∏–∂–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</p>
    </div>

    <div style="margin: 15px 0;">
        <label><strong>–í–≤–µ–¥–∏—Ç–µ SMS –∫–æ–¥:</strong></label><br>
        <input type="text" id="smsCode" placeholder="–í–≤–µ–¥–∏—Ç–µ 3-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥" maxlength="3" style="width: 150px;">
        <button onclick="verifySms()">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å SMS</button>
    </div>

    <div id="step3-result"></div>
</div>

<!-- –®–∞–≥ 4: –†–µ–∑—É–ª—å—Ç–∞—Ç -->
<div class="step hidden" id="step4">
    <h3>4. –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–ª–∞—Ç—ã</h3>
    <div id="step4-result"></div>
    <button onclick="location.reload()">üîÑ –ù–æ–≤—ã–π —Ç–µ—Å—Ç</button>
</div>

<script>
    let testData = {};
    let verificationToken = '';
    let resultToken = '';
    let generatedSmsCode = '';

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ API
    async function checkApiStatus() {
        try {
            const response = await fetch('/api/test/status');
            const data = await response.json();

            document.getElementById('status-result').innerHTML = `
                    <div class="success">
                        <p>‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
        } catch (error) {
            document.getElementById('status-result').innerHTML = `
                    <div class="error">
                        <p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API</p>
                        <p>${error.message}</p>
                    </div>
                `;
        }
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    async function createTestData() {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';

        try {
            const response = await fetch('/api/test/create-test-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            const data = await response.json();

            if (response.ok && data.success) {
                testData = data;
                document.getElementById('step1-result').innerHTML = `
                        <div class="success">
                            <p>‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ!</p>
                            <p><strong>–†–µ—Å—Ç–æ—Ä–∞–Ω:</strong> ${data.restaurant_name}</p>
                            <p><strong>–°—Ç–æ–ª:</strong> #${data.table_number} (${data.table_seats} –º–µ—Å—Ç)</p>
                            <p><strong>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ID:</strong> ${data.reservation_id}</p>
                            <p><strong>–¢–æ–∫–µ–Ω:</strong> ${data.access_token ? '‚úì –ü–æ–ª—É—á–µ–Ω' : '‚úó –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
                        </div>
                    `;

                document.getElementById('booking-info').innerHTML = `
                        <p><strong>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> –°—Ç–æ–ª #${data.table_number} –≤ "${data.restaurant_name}"</p>
                        <p><strong>–í—Ä–µ–º—è:</strong> –ó–∞–≤—Ç—Ä–∞ 19:00</p>
                        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç:</strong> ${data.table_seats}</p>
                        <p><strong>–¢–µ—Å—Ç–æ–≤–∞—è —Å—É–º–º–∞:</strong> 1500 ‚ÇΩ</p>
                    `;

                document.getElementById('step2').classList.remove('hidden');
            } else {
                document.getElementById('step1-result').innerHTML = `
                        <div class="error">
                            <p>‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö</p>
                            <p>${data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                            ${data.trace ? `<pre>${data.trace}</pre>` : ''}
                        </div>
                    `;
            }
        } catch (error) {
            document.getElementById('step1-result').innerHTML = `
                    <div class="error">
                        <p>‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞</p>
                        <p>${error.message}</p>
                    </div>
                `;
        } finally {
            btn.disabled = false;
            btn.textContent = '–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ';
        }
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤)
    function formatCardNumber(input) {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
        let value = input.value.replace(/\D/g, '');

        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –∫–∞–∂–¥—ã–µ 4 —Ü–∏—Ñ—Ä—ã
        let formattedValue = '';
        for (let i = 0; i < value.length; i++) {
            if (i > 0 && i % 4 === 0) {
                formattedValue += ' ';
            }
            formattedValue += value[i];
        }

        input.value = formattedValue;
    }

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π –∫–∞—Ä—Ç—ã –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    function fillCardFromSelect() {
        const select = document.getElementById('cardSelect');
        const cardNumber = document.getElementById('cardNumber');

        if (select.value) {
            cardNumber.value = select.value.replace(/(.{4})/g, '$1 ').trim();
        }
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
    function validateCardNumber(cardNumber) {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã
        const cleanNumber = cardNumber.replace(/\s/g, '');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É (13-19 —Ü–∏—Ñ—Ä)
        if (cleanNumber.length < 13 || cleanNumber.length > 19) {
            return false;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
        if (!/^\d+$/.test(cleanNumber)) {
            return false;
        }

        return true;
    }

    // –ù–∞—á–∞–ª–æ –æ–ø–ª–∞—Ç—ã
    async function startPayment() {
        const cardNumber = document.getElementById('cardNumber').value;
        const cardExpMonth = document.getElementById('cardExpMonth').value;
        const cardExpYear = document.getElementById('cardExpYear').value;
        const cardCvc = document.getElementById('cardCvc').value;

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
        if (!validateCardNumber(cardNumber)) {
            document.getElementById('step2-result').innerHTML = `
                    <div class="error">
                        <p>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</p>
                        <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã (13-19 —Ü–∏—Ñ—Ä)</p>
                    </div>
                `;
            return;
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
        if (!cardExpMonth || !cardExpYear || !cardCvc) {
            document.getElementById('step2-result').innerHTML = `
                    <div class="error">
                        <p>‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–∞—Ä—Ç—ã</p>
                    </div>
                `;
            return;
        }

        // –û—á–∏—â–∞–µ–º –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const cleanCardNumber = cardNumber.replace(/\s/g, '');

        const paymentData = {
            reservation_id: testData.reservation_id,
            amount: 1500.00,
            currency: 'RUB',
            card_number: cleanCardNumber,
            card_exp_month: parseInt(cardExpMonth),
            card_exp_year: parseInt(cardExpYear),
            card_cvc: cardCvc,
            save_card: false
        };

        try {
            const response = await fetch('/api/payments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Authorization': 'Bearer ' + testData.access_token
                },
                body: JSON.stringify(paymentData)
            });

            const result = await response.json();

            if (response.ok) {
                verificationToken = result.verification_token;
                generatedSmsCode = result.sms_code;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º SMS –∫–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                document.getElementById('generated-sms-code').textContent = generatedSmsCode;
                document.getElementById('sms-code-display').classList.remove('hidden');

                document.getElementById('step2-result').innerHTML = `
                        <div class="success">
                            <p>‚úÖ –ü–ª–∞—Ç–µ–∂ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!</p>
                            <p>Payment ID: ${result.payment_id}</p>
                            <p>SMS –∫–æ–¥: ${result.sms_code}</p>
                        </div>
                    `;
                document.getElementById('step3').classList.remove('hidden');
            } else {
                document.getElementById('step2-result').innerHTML = `
                        <div class="error">
                            <p>‚ùå –û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã</p>
                            <p>${result.message || JSON.stringify(result.errors)}</p>
                        </div>
                    `;
            }
        } catch (error) {
            document.getElementById('step2-result').innerHTML = `
                    <div class="error">
                        <p>‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞</p>
                        <p>${error.message}</p>
                    </div>
                `;
        }
    }

    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ SMS
    async function verifySms() {
        const smsCodeInput = document.getElementById('smsCode');
        const smsCode = smsCodeInput.value.trim();

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞
        if (smsCode.length !== 3 || !/^\d{3}$/.test(smsCode)) {
            document.getElementById('step3-result').innerHTML = `
                    <div class="error">
                        <p>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞</p>
                        <p>–í–≤–µ–¥–∏—Ç–µ 3 —Ü–∏—Ñ—Ä—ã (–æ—Ç 100 –¥–æ 999)</p>
                    </div>
                `;
            return;
        }

        try {
            const response = await fetch('/api/payments/verify-sms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Authorization': 'Bearer ' + testData.access_token
                },
                body: JSON.stringify({
                    verification_token: verificationToken,
                    sms_code: smsCode
                })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                resultToken = result.result_token;
                document.getElementById('step3-result').innerHTML = `
                        <div class="success">
                            <p>‚úÖ SMS –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!</p>
                            <p>–°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞: ${result.status}</p>
                            <p>Payment ID: ${result.payment_id}</p>
                        </div>
                    `;
                document.getElementById('step4').classList.remove('hidden');
                await loadPaymentResult();
            } else {
                document.getElementById('step3-result').innerHTML = `
                        <div class="error">
                            <p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</p>
                            <p>${result.message}</p>
                            ${result.remaining_attempts ? `<p>–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: ${result.remaining_attempts}</p>` : ''}
                        </div>
                    `;
            }
        } catch (error) {
            document.getElementById('step3-result').innerHTML = `
                    <div class="error">
                        <p>‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞</p>
                        <p>${error.message}</p>
                    </div>
                `;
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    async function loadPaymentResult() {
        try {
            const response = await fetch(`/api/payments/result/${resultToken}`, {
                headers: {
                    'Authorization': 'Bearer ' + testData.access_token
                }
            });

            const result = await response.json();

            if (response.ok) {
                const statusClass = result.status === 'approved' ? 'success' : 'error';
                const statusIcon = result.status === 'approved' ? '‚úÖ' : '‚ùå';
                const statusText = result.status === 'approved' ? '–£–°–ü–ï–®–ù–û' : '–û–¢–ö–õ–û–ù–ï–ù–û';

                document.getElementById('step4-result').innerHTML = `
                        <div class="${statusClass}">
                            <h3>${statusIcon} –û–ü–õ–ê–¢–ê ${statusText}</h3>
                            <p><strong>ID –ø–ª–∞—Ç–µ–∂–∞:</strong> ${result.payment_id}</p>
                            <p><strong>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> #${testData.reservation_id}</p>
                            <p><strong>–°—É–º–º–∞:</strong> ${(result.amount_rubles / 100).toFixed(2)} ${result.currency}</p>
                            <p><strong>–ö–∞—Ä—Ç–∞:</strong> ${result.card_brand} ****${result.card_last4}</p>
                            <p><strong>–†–µ—Ñ–µ—Ä–µ–Ω—Å:</strong> ${result.provider_reference}</p>
                            <p><strong>–í—Ä–µ–º—è:</strong> ${new Date(result.created_at).toLocaleString('ru-RU')}</p>
                        </div>
                    `;
            } else {
                document.getElementById('step4-result').innerHTML = `
                        <div class="error">
                            <p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</p>
                            <p>${result.message}</p>
                        </div>
                    `;
            }
        } catch (error) {
            document.getElementById('step4-result').innerHTML = `
                    <div class="error">
                        <p>‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞</p>
                        <p>${error.message}</p>
                    </div>
                `;
        }
    }

    // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É –ø–æ–ª—è–º–∏ –≤–≤–æ–¥–∞
    document.getElementById('smsCode').addEventListener('input', function(e) {
        if (this.value.length === 3) {
            verifySms();
        }
    });
</script>
</body>
</html>
